
<!DOCTYPE html>
<html>
<head>
<title>NH65 Advanced Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&libraries=routes,places&callback=initMapCallback"></script>
<!-- Fallback: Leaflet map library (no API key required) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        margin: 0;
        padding: 20px;
    }
    h2, h3 {
        color: #333;
    }
    .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
    }
    .chart-container, .traffic-container, .map-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #map {
        width: 100%;
        height: 500px;
        border-radius: 8px;
        position: relative;
    }
    .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .loading-text {
        text-align: center;
        color: #666;
        font-size: 14px;
        margin-top: 10px;
    }
    .traffic-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin: 10px 0;
        text-align: center;
    }
    .traffic-card h4 {
        margin: 0 0 10px 0;
        font-size: 18px;
    }
    .traffic-status {
        font-size: 24px;
        font-weight: bold;
        margin: 10px 0;
    }
    .traffic-density {
        font-size: 14px;
        margin: 10px 0;
    }
    .traffic-count {
        font-size: 16px;
        margin-top: 10px;
    }
    .light { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); color: #333; }
    .moderate { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: #333; }
    .heavy { background: linear-gradient(135deg, #ff6b6b 0%, #ff8e72 100%); color: white; }
    .congested { background: linear-gradient(135deg, #a8061d 0%, #ff0000 100%); color: white; }
    .peak-analysis {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-top: 20px;
    }
    .full-width {
        grid-column: 1 / -1;
    }
    .route-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
    }
    .route-info h4 {
        margin-top: 0;
    }
    .alert-box {
        padding: 12px;
        margin: 10px 0;
        border-radius: 8px;
        color: #222;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        display: block;
    }
    .alert-severity-high { background: linear-gradient(90deg,#ffe6e6,#ffd1d1); border-left:4px solid #e74c3c; }
    .alert-severity-medium { background: linear-gradient(90deg,#fff4e6,#fff0d1); border-left:4px solid #f39c12; }
    .alert-severity-low { background: linear-gradient(90deg,#e8fff0,#dfffe6); border-left:4px solid #2ecc71; }
    .alert-title { font-weight:700; margin-bottom:6px; }
    .info-row {
        display: flex;
        justify-content: space-between;
        margin: 8px 0;
        padding: 8px;
        background: rgba(255,255,255,0.1);
        border-radius: 4px;
    }
    canvas {
        max-width: 100%;
    }
</style>
</head>
<body>

<h2>NH65 Real-Time Vehicle Analytics & Traffic Dashboard</h2>

<div class="container">
    <div class="chart-container full-width">
        <h3>Vehicle Count Trend</h3>
        <canvas id="lineChart" width="400" height="150"></canvas>
    </div>
    
    <div class="chart-container">
        <h3>Vehicle Count per Toll Plaza</h3>
        <canvas id="barChart" width="400" height="200"></canvas>
    </div>
    
    <div class="traffic-container">
        <h3>Live Traffic Status</h3>
        <div id="trafficStatus"></div>
    </div>
    
    <div class="map-container full-width">
        <h3>NH65 Live Route Traffic Map</h3>
        <div style="position: relative;">
            <div id="map" style="width: 100%; height: 500px; border-radius: 8px; background-color: #f0f0f0;"></div>
            <div id="mapLoader" class="loader" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10;"></div>
            <div id="mapLoadingText" class="loading-text" style="position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%); width: 100%; z-index: 10;">Loading live traffic map...</div>
        </div>
        <div id="routeInfo"></div>
    </div>
</div>

<div class="peak-analysis">
    <h3>Peak Hours Analysis (24-hour)</h3>
    <div id="peakAnalysis"></div>
</div>

<div class="peak-analysis">
    <h3>Live Alerts</h3>
    <div id="alerts" style="min-height:40px;">Loading alerts...</div>
</div>

<div class="peak-analysis">
    <h3>All Vehicle Records (Last 100)</h3>
    <div style="max-height: 400px; overflow-y: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background-color: #667eea; color: white; position: sticky; top: 0;">
                    <th style="border: 1px solid #ddd; padding: 10px;">Vehicle ID</th>
                    <th style="border: 1px solid #ddd; padding: 10px;">Toll Plaza</th>
                    <th style="border: 1px solid #ddd; padding: 10px;">Timestamp</th>
                </tr>
            </thead>
            <tbody id="recordsTable">
                <tr><td colspan="3" style="text-align: center; padding: 20px;">Loading records...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
let map;
let directionsService;
let directionsRenderer;
let timeLabels = [];
let trendData = [];
let googleMapsLoaded = false;

// Callback for async Google Maps loading
function initMapCallback() {
    console.log('Google Maps API loaded successfully');
    googleMapsLoaded = true;
    initMap();
}

// Error handler for Google Maps
window.gm_authFailure = function() {
    console.error('Google Maps API authentication failed');
    console.log('Using Leaflet fallback map instead');
    initLeafletMap();
};

// Initialize Leaflet map as fallback
function initLeafletMap() {
    try {
        const mapElement = document.getElementById('map');
        if (!mapElement || map) return; // Already initialized
        
        // Initialize Leaflet map
        map = L.map('map').setView([16.5, 79.5], 8);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Add NH65 route markers
        const vijayawada = L.marker([16.5062, 80.6480], {
            title: 'Vijayawada'
        }).bindPopup('Vijayawada Start').addTo(map);
        
        const hyderabad = L.marker([17.3850, 78.4867], {
            title: 'Hyderabad'
        }).bindPopup('Hyderabad End').addTo(map);
        
        // Draw route line (approximate)
        const routePoints = [
            [16.5062, 80.6480],
            [16.8, 80.3],
            [17.0, 79.8],
            [17.2, 79.2],
            [17.3850, 78.4867]
        ];
        
        L.polyline(routePoints, {
            color: '#FF0000',
            weight: 3,
            opacity: 0.7
        }).addTo(map);
        
        // Hide loader
        const mapLoader = document.getElementById('mapLoader');
        const mapLoadingText = document.getElementById('mapLoadingText');
        if (mapLoader) mapLoader.style.display = 'none';
        if (mapLoadingText) {
            mapLoadingText.innerHTML = 'üìç Using OpenStreetMap (Google Maps unavailable)';
            mapLoadingText.style.color = '#FFA500';
            setTimeout(() => { if (mapLoadingText) mapLoadingText.style.display = 'none'; }, 3000);
        }
        
        console.log('Leaflet map initialized successfully');
    } catch (error) {
        console.error('Error initializing Leaflet map:', error);
        const mapLoadingText = document.getElementById('mapLoadingText');
        if (mapLoadingText) {
            mapLoadingText.innerHTML = '‚ùå Map loading error: ' + error.message;
            mapLoadingText.style.color = '#ff6b6b';
        }
    }
}

function initMap() {
    // Check if Google Maps API is available
    if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
        console.error('Google Maps API not loaded');
        const mapLoader = document.getElementById('mapLoader');
        const mapLoadingText = document.getElementById('mapLoadingText');
        if (mapLoader) mapLoader.style.display = 'none';
        if (mapLoadingText) {
            mapLoadingText.innerHTML = '‚ö†Ô∏è Google Maps API not available<br><small>Enable Maps JavaScript API in Google Cloud Console</small>';
            mapLoadingText.style.color = '#ff6b6b';
        }
        return;
    }
    
    console.log('Initializing map...');
    
    try {
        const mapElement = document.getElementById('map');
        if (!mapElement) {
            console.error('Map element not found');
            return;
        }
        
        const nh65Center = { lat: 16.5, lng: 79.5 };
        map = new google.maps.Map(mapElement, {
            zoom: 8,
            center: nh65Center,
            mapTypeId: 'roadmap'
        });
        
        // Add traffic layer
        const trafficLayer = new google.maps.TrafficLayer();
        trafficLayer.setMap(map);
        
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            polylineOptions: {
                strokeColor: '#FF0000',
                strokeWeight: 5
            }
        });
        directionsRenderer.setMap(map);
        
        // Hide loader once map is ready
        const mapLoader = document.getElementById('mapLoader');
        const mapLoadingText = document.getElementById('mapLoadingText');
        if (mapLoader) mapLoader.style.display = 'none';
        if (mapLoadingText) mapLoadingText.style.display = 'none';
        
        console.log('Google Maps initialized successfully');
    } catch (mapError) {
        console.error('Google Maps initialization failed:', mapError);
        console.log('Falling back to Leaflet map...');
        initLeafletMap();
    }
}

const lineChart = new Chart(document.getElementById("lineChart"), {
    type: "line",
    data: {
        labels: timeLabels,
        datasets: [{
            label: "Total Vehicle Count Trend",
            data: trendData,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

const barChart = new Chart(document.getElementById("barChart"), {
    type: "bar",
    data: {
        labels: [],
        datasets: [{
            label: "Vehicle Count",
            data: [],
            backgroundColor: [
                '#667eea',
                '#764ba2',
                '#f093fb'
            ],
            borderColor: '#333',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

async function refreshData() {
    try {
        console.log('Starting data refresh...');
        
        // Fetch vehicle count data
        const res = await fetch("/api/live-data");
        if (!res.ok) throw new Error(`Live data failed: ${res.status}`);
        const data = await res.json();
        console.log('Live data:', data);

        const total = data.reduce((a,b) => a + b.count, 0);
        timeLabels.push(new Date().toLocaleTimeString());
        trendData.push(total);
        if(timeLabels.length > 12) {
            timeLabels.shift();
            trendData.shift();
        }

        lineChart.update();

        barChart.data.labels = data.map(d => d.toll);
        barChart.data.datasets[0].data = data.map(d => d.count);
        barChart.update();
        console.log('Charts updated');

        // Fetch traffic status data
        const trafficRes = await fetch("/api/traffic-status");
        if (!trafficRes.ok) throw new Error(`Traffic status failed: ${trafficRes.status}`);
        const trafficData = await trafficRes.json();
        console.log('Traffic data:', trafficData);
        
        // Update traffic cards
        const trafficHTML = trafficData.traffic.map(t => {
            const statusClass = t.status.toLowerCase().replace(" ", "");
            return `
                <div class="traffic-card ${statusClass}">
                    <h4>${t.toll_id}</h4>
                    <div class="traffic-status">${t.status}</div>
                    <div class="traffic-density">Density: ${t.density}%</div>
                    <div class="traffic-count">Vehicles: ${t.vehicle_count}</div>
                </div>
            `;
        }).join('');
        document.getElementById('trafficStatus').innerHTML = trafficHTML;
        
        // Update peak analysis
        const peak = trafficData.peak_hours;
        document.getElementById('peakAnalysis').innerHTML = `
            <p><strong>Total Vehicles (24h):</strong> ${peak.total_vehicles_24h}</p>
            <p><strong>Average Hourly:</strong> ${peak.avg_hourly} vehicles/hour</p>
            <p><strong>Peak Status:</strong> <span style="color: ${peak.peak_status === 'High' ? 'red' : peak.peak_status === 'Moderate' ? 'orange' : 'green'}">${peak.peak_status}</span></p>
        `;
        console.log('Traffic cards updated');
        
        // Fetch all vehicle records
        const recordsRes = await fetch("/api/all-records");
        if (!recordsRes.ok) throw new Error(`Records failed: ${recordsRes.status}`);
        const recordsData = await recordsRes.json();
        console.log('Records data:', recordsData);
        
        if (recordsData.records && recordsData.records.length > 0) {
            const recordsHTML = recordsData.records.map((r, idx) => `
                <tr style="${idx % 2 === 0 ? 'background-color: #f9f9f9;' : ''}">
                    <td style="border: 1px solid #ddd; padding: 8px;">${r.vehicle_id}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${r.toll_id}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${new Date(r.timestamp * 1000).toLocaleString()}</td>
                </tr>
            `).join('');
            document.getElementById('recordsTable').innerHTML = recordsHTML;
        } else {
            document.getElementById('recordsTable').innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px;">No records found</td></tr>';
        }
        console.log('Records table updated');
        
        // Load Google Maps route traffic asynchronously (non-blocking)
        loadRouteTrafficAsync();
        loadAlertsAsync();
        
    } catch (error) {
        console.error('Error fetching data:', error);
    }
}

// Fetch and display alerts
async function loadAlertsAsync() {
    try {
        const res = await fetch('/api/alerts');
        if (!res.ok) throw new Error('Alerts fetch failed');
        const data = await res.json();
        const alerts = data.alerts || [];
        const container = document.getElementById('alerts');
        if (!container) return;
        if (alerts.length === 0) {
            container.innerHTML = '<div style="color:green">No active alerts</div>';
            return;
        }

        const html = alerts.map(a => {
            const timeStr = a.timestamp ? new Date(a.timestamp * 1000).toLocaleString() : '';
            // Determine severity class
            let sevClass = 'alert-severity-low';
            if (a.type === 'accident') sevClass = 'alert-severity-high';
            else if (a.type === 'congestion') sevClass = 'alert-severity-medium';
            else if (a.type === 'delay') sevClass = 'alert-severity-medium';

            if (a.type === 'accident') {
                return `
                    <div class="alert-box ${sevClass}">
                        <div class="alert-title">‚ö†Ô∏è ${a.message}</div>
                        <div>Location: ${a.toll || a.route || ''}</div>
                        <div>Vehicles: ${a.vehicle_count || 'N/A'}</div>
                        <div style="font-size:12px; color:#555; margin-top:6px;">${timeStr}</div>
                    </div>`;
            }

            if (a.type === 'congestion') {
                return `
                    <div class="alert-box ${sevClass}">
                        <div class="alert-title">üö¶ ${a.message}</div>
                        <div>Location: ${a.toll || a.route || ''}</div>
                        <div>Vehicles: ${a.vehicle_count || 'N/A'}</div>
                        <div style="font-size:12px; color:#555; margin-top:6px;">${timeStr}</div>
                    </div>`;
            }

            if (a.type === 'delay') {
                return `
                    <div class="alert-box ${sevClass}">
                        <div class="alert-title">‚è±Ô∏è ${a.message}</div>
                        <div>Delay: ${a.delay_min || 'N/A'} min</div>
                        <div style="font-size:12px; color:#555; margin-top:6px;">${timeStr}</div>
                    </div>`;
            }

            // Generic fallback
            return `
                <div class="alert-box ${sevClass}">
                    <div class="alert-title">Info</div>
                    <div>${(a.message) ? a.message : JSON.stringify(a)}</div>
                    <div style="font-size:12px; color:#555; margin-top:6px;">${timeStr}</div>
                </div>`;
        }).join('');

        container.innerHTML = html;
    } catch (e) {
        console.error('Error loading alerts', e);
        const container = document.getElementById('alerts');
        if (container) container.innerHTML = `<div style="color:#ff6b6b">Error loading alerts</div>`;
    }
}

// Async function to load route traffic without blocking other data
async function loadRouteTrafficAsync() {
    try {
        const routeRes = await fetch("/api/nh65-route-traffic");
        if (!routeRes.ok) throw new Error(`Route traffic failed: ${routeRes.status}`);
        const routeData = await routeRes.json();
        
        console.log('Route data:', routeData);
        
        if (routeData.routes && routeData.routes.length > 0) {
            const route = routeData.routes[0];
            
            // Hide loader after short delay
            const mapLoader = document.getElementById('mapLoader');
            const mapLoadingText = document.getElementById('mapLoadingText');
            
            setTimeout(() => {
                if (mapLoader) mapLoader.style.display = 'none';
                if (mapLoadingText) mapLoadingText.style.display = 'none';
                console.log('Loader hidden, map should be visible');
            }, 500);
            
            // Check if there's an error in the route data
            if (route.error) {
                console.error('Route error:', route.error);
                document.getElementById('routeInfo').innerHTML = `
                    <div class="route-info">
                        <p>Route information unavailable: ${route.error}</p>
                        <p>Displaying static NH65 route (Vijayawada to Hyderabad)</p>
                    </div>
                `;
                
                // Draw a basic route line anyway
                if (map && directionsService) {
                    directionsService.route({
                        origin: 'Vijayawada, Andhra Pradesh, India',
                        destination: 'Hyderabad, Telangana, India',
                        travelMode: 'DRIVING'
                    }, (result, status) => {
                        if (status === 'OK') {
                            directionsRenderer.setDirections(result);
                            console.log('Route drawn on map');
                        } else {
                            console.error('Directions request failed:', status);
                        }
                    });
                } else {
                    // If Google Directions not available, draw decoded polyline on Leaflet
                    if (route.polyline) {
                        drawPolylineOnLeaflet(route.polyline);
                        console.log('Polyline drawn on Leaflet fallback');
                    }
                }
            } else {
                // Display route on map
                if (map && directionsService) {
                    directionsService.route({
                        origin: route.origin,
                        destination: route.destination,
                        travelMode: 'DRIVING'
                    }, (result, status) => {
                        if (status === 'OK') {
                            directionsRenderer.setDirections(result);
                            console.log('Route rendered successfully');
                        } else {
                            console.error('Directions error:', status);
                        }
                    });
                } else {
                    // If Google Directions not available, draw decoded polyline on Leaflet
                    if (route.polyline) {
                        drawPolylineOnLeaflet(route.polyline);
                        console.log('Polyline drawn on Leaflet fallback (route)');
                    }
                }
                
                // Display route info
                const routeHTML = `
                    <div class="route-info">
                        <h4>üìç ${route.route_name}</h4>
                        <div class="info-row">
                            <span><strong>Distance:</strong></span>
                            <span>${route.distance_km} km</span>
                        </div>
                        <div class="info-row">
                            <span><strong>Normal Time:</strong></span>
                            <span>${route.normal_time_min} min</span>
                        </div>
                        <div class="info-row">
                            <span><strong>Current Traffic Time:</strong></span>
                            <span>${route.traffic_time_min} min</span>
                        </div>
                        <div class="info-row">
                            <span><strong>Current Delay:</strong></span>
                            <span style="color: ${route.delay_min > 10 ? '#ff6b6b' : '#84fab0'}">${route.delay_min} min</span>
                        </div>
                    </div>
                `;
                document.getElementById('routeInfo').innerHTML = routeHTML;
            }
        } else {
            console.warn('No routes in response');
            const mapLoader = document.getElementById('mapLoader');
            const mapLoadingText = document.getElementById('mapLoadingText');
            if (mapLoader) mapLoader.style.display = 'none';
            if (mapLoadingText) mapLoadingText.innerHTML = 'No route data available';
        }
    } catch (routeError) {
        console.error('Error loading route data:', routeError);
        const mapLoader = document.getElementById('mapLoader');
        const mapLoadingText = document.getElementById('mapLoadingText');
        if (mapLoader) mapLoader.style.display = 'none';
        if (mapLoadingText) mapLoadingText.innerHTML = `Error loading map: ${routeError.message}`;
        document.getElementById('routeInfo').innerHTML = '<p style="color: #ff6b6b;">Error loading route information</p>';
    }
}

// Decode Google encoded polyline to array of [lat, lng]
function decodePolyline(encoded) {
    if (!encoded) return [];
    let points = [];
    let index = 0, len = encoded.length;
    let lat = 0, lng = 0;

    while (index < len) {
        let b, shift = 0, result = 0;
        do {
            b = encoded.charCodeAt(index++) - 63;
            result |= (b & 0x1f) << shift;
            shift += 5;
        } while (b >= 0x20);
        let dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
        lat += dlat;

        shift = 0;
        result = 0;
        do {
            b = encoded.charCodeAt(index++) - 63;
            result |= (b & 0x1f) << shift;
            shift += 5;
        } while (b >= 0x20);
        let dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
        lng += dlng;

        points.push([lat / 1e5, lng / 1e5]);
    }
    return points;
}

// Draw decoded polyline on Leaflet map if available
function drawPolylineOnLeaflet(encodedPolyline) {
    try {
        if (typeof L === 'undefined' || !map) return;
        const latlngs = decodePolyline(encodedPolyline);
        if (!latlngs || latlngs.length === 0) return;
        // Convert to Leaflet LatLng objects
        const leafletPoints = latlngs.map(p => [p[0], p[1]]);
        L.polyline(leafletPoints, { color: '#FF0000', weight: 3, opacity: 0.7 }).addTo(map);
    } catch (e) {
        console.error('Error drawing polyline on Leaflet:', e);
    }
}

// Initialize map when page loads
window.addEventListener('load', () => {
    try {
        // Always start refreshing data immediately, don't wait for map
        refreshData();
        setInterval(refreshData, 5000);
        
        // Google Maps will call initMapCallback() when API is loaded
        // If it's not loaded after 5 seconds, use Leaflet fallback
        setTimeout(() => {
            if (!googleMapsLoaded) {
                console.warn('Google Maps API failed to load after 5 seconds, using Leaflet fallback');
                initLeafletMap();
            }
        }, 5000);
    } catch (error) {
        console.error('Error initializing dashboard:', error);
        // Still try to refresh data and show fallback map
        refreshData();
        setInterval(refreshData, 5000);
        initLeafletMap();
    }
});

// Add keyboard shortcut to refresh manually
document.addEventListener('keydown', (e) => {
    if (e.key === 'r' && e.ctrlKey) {
        e.preventDefault();
        refreshData();
        console.log('Data refreshed manually');
    }
});
</script>

</body>
</html>
